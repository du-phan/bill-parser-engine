# Pipeline Testing Directory

This directory contains comprehensive testing for the Normative Reference Resolver pipeline.

## Contents

### Test Script

- **`test_simple_pipeline.py`** - The comprehensive test script that runs the complete pipeline with real data and API calls. Features include:
  - Rate limiting (2-second delays between API calls) to avoid HTTP 429 errors
  - Detailed JSON logging of all component inputs and outputs
  - Both detailed component-by-component testing and full pipeline testing
  - Proper environment handling and error recovery
  - Comprehensive validation of all 8 pipeline steps

### Log Files

- **`pipeline_with_rate_limiting_*.log`** - Detailed logs from pipeline runs (generated by test script)

### Cache Directory

- **`cache/`** - Cached results from API calls and text retrieval

## Usage

### Running the Test

```bash
cd tests/pipeline_testing
python test_simple_pipeline.py
```

This will:

1. Load environment variables from `.env.local`
2. Run the complete 8-step pipeline with rate limiting
3. Generate detailed logs showing all component inputs/outputs
4. Save results to timestamped log files

### Test Features

- **Rate Limiting**: 15-second delays between API calls to avoid HTTP 429 errors
- **Comprehensive Logging**: All component inputs/outputs logged in JSON format
- **Error Handling**: Graceful fallbacks for API failures
- **Reference Resolution**: Full recursive reference resolution with cycle detection
- **Position Validation**: Smart position correction for LLM-identified references
- **Dual Testing Mode**: Both detailed component testing AND full pipeline testing

### Environment Setup

Ensure `.env.local` contains:

```
MISTRAL_API_KEY=your_mistral_api_key
LEGIFRANCE_CLIENT_ID=your_legifrance_client_id
LEGIFRANCE_CLIENT_SECRET=your_legifrance_client_secret
```

### Output Analysis

Log files contain detailed traces of:

- Bill splitting results
- Target article identification (98% confidence achieved)
- Original text retrieval (3,185+ characters from cache/API)
- Text reconstruction (before/after states)
- Reference location (16+ references found)
- Reference object linking (grammatical analysis)
- Resolution orchestration (recursive reference resolution)
- Legal state synthesis (final before/after legal states)

### Performance Metrics

Recent test results:

- **References Found**: 16 normative references
- **References Linked**: 7 successfully linked with grammatical objects
- **References Resolved**: 10 definitional references resolved recursively
- **Output Expansion**: 3,185 â†’ 8,304 characters (2.6x with full resolution)
- **API Calls**: Successfully rate-limited, no 429 errors
